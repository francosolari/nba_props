# Multi-stage Development Dockerfile with Frontend Build - Production Database
FROM node:16 AS frontend-builder

WORKDIR /build

# Copy package files
COPY package.json package-lock.json* ./
COPY frontend/ ./frontend/

# Install dependencies and build frontend
RUN npm install
RUN npm run build

# Python stage
FROM python:3.11-slim-bullseye

ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Copy requirements and install
COPY backend/requirements.txt /app/
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# Copy backend code
COPY backend/ /app/

# Copy the prod-db .env file as the default .env
COPY backend/.env.docker.prod-db /app/.env

# Copy frontend build from frontend-builder stage
COPY --from=frontend-builder /build/frontend/static /app/../frontend/static

# Collect static files
RUN python manage.py collectstatic --noinput

ENV DJANGO_SETTINGS_MODULE=nba_predictions.settings

EXPOSE 8000

# Development server
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
