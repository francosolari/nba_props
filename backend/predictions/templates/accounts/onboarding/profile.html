{% extends "allauth/layouts/base.html" %}
{% load static %}

{% block head_title %}Set Up Your Profile{% endblock head_title %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl w-full">
        {# Progress Bar #}
        <div class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Step {{ current_step }} of {{ total_steps }}</span>
                <span class="text-sm font-medium text-gray-700">{{ onboarding.progress_percentage }}% Complete</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: {{ onboarding.progress_percentage }}%"></div>
            </div>
        </div>

        {# Profile Setup Card #}
        <div class="bg-white rounded-xl shadow-lg p-8 md:p-12">
            <div class="text-center mb-8">
                {# Profile Icon #}
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-6">
                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>

                <h1 class="text-3xl font-bold text-gray-900 mb-3">
                    Set Up Your Profile
                </h1>
                <p class="text-gray-600">
                    This information will be displayed on the leaderboard and when you interact with other players.
                </p>
            </div>

            {# Error Messages #}
            {% if messages %}
                {% for message in messages %}
                    <div class="mb-6 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            {# Profile Form #}
            <form method="post" class="space-y-6">
                {% csrf_token %}

                {# Username Field #}
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                        Username {% if onboarding.needs_username %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <input type="text"
                           id="username"
                           name="username"
                           value="{{ user.username }}"
                           {% if onboarding.needs_username %}required{% endif %}
                           class="block w-full px-4 py-3 text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Choose a username">
                    <p class="mt-2 text-sm text-gray-500">
                        This will be your display name on leaderboards
                    </p>
                    {% if onboarding.needs_username %}
                        <p class="mt-1 text-sm text-orange-600">
                            You signed in with Google. Please choose a username for the leaderboard.
                        </p>
                    {% endif %}
                </div>

                {# First Name Field #}
                <div>
                    <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                        First Name (Optional)
                    </label>
                    <input type="text"
                           id="first_name"
                           name="first_name"
                           value="{{ user.first_name }}"
                           class="block w-full px-4 py-3 text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Your first name">
                </div>

                {# Last Name Field #}
                <div>
                    <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Last Name (Optional)
                    </label>
                    <input type="text"
                           id="last_name"
                           name="last_name"
                           value="{{ user.last_name }}"
                           class="block w-full px-4 py-3 text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Your last name">
                    <p class="mt-2 text-sm text-gray-500">
                        If provided, your display name will show as "FirstName L." for privacy
                    </p>
                </div>

                {# Current Info Display #}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <p class="text-sm font-medium text-gray-700 mb-1">Preview</p>
                    <p class="text-gray-600">Display name: <span id="display-name-preview" class="font-semibold">{{ user.userprofile.display_name|default:user.username }}</span></p>
                    <p class="text-gray-600">Email: <span class="font-semibold">{{ user.email }}</span></p>
                </div>

                {# Action Buttons #}
                <div class="space-y-3">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        Continue
                    </button>

                    <button type="button" onclick="document.getElementById('skip-form').submit()" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">
                        Skip for now
                    </button>
                </div>
            </form>

            {# Hidden skip form #}
            <form id="skip-form" method="post" action="{% url 'skip_onboarding' %}" style="display: none;">
                {% csrf_token %}
            </form>
        </div>
    </div>
</div>

<script>
    // Update display name preview in real-time
    function updateDisplayNamePreview() {
        const username = document.getElementById('username').value;
        const firstName = document.getElementById('first_name').value;
        const lastName = document.getElementById('last_name').value;
        const preview = document.getElementById('display-name-preview');

        let displayName;
        if (firstName && lastName) {
            // If both first and last name provided: "FirstName L."
            displayName = `${firstName} ${lastName.charAt(0)}.`;
        } else if (firstName) {
            // If only first name: use first name
            displayName = firstName;
        } else if (username) {
            // If no name provided: use username
            displayName = username;
        } else {
            displayName = '(not set)';
        }

        preview.textContent = displayName;
    }

    // Add event listeners to update preview on input
    document.getElementById('username').addEventListener('input', updateDisplayNamePreview);
    document.getElementById('first_name').addEventListener('input', updateDisplayNamePreview);
    document.getElementById('last_name').addEventListener('input', updateDisplayNamePreview);

    // Initialize preview on page load
    updateDisplayNamePreview();
</script>
{% endblock content %}
